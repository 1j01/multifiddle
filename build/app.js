// Generated by CoffeeScript 2.3.0
(function() {
  var $G, E, G, fb_project, fb_root, hash, project_id, themes, themesByName, wait_then, what_to_show;

  ({themes, themesByName} = ace.require("ace/ext/themelist"));

  $G = $(G = window);

  E = function(tagname) {
    return document.createElement(tagname);
  };

  wait_then = function(fn) {
    var tid;
    tid = -1;
    return function(...args) {
      clearTimeout(tid);
      return tid = setTimeout(function() {
        return fn(...args);
      }, 100);
    };
  };

  this.Project = class Project {
    constructor(fb, what_to_show) {
      var bottom_pane, top_pane;
      this.fb = fb;
      // @TODO: Load from Firebase
      this.languages = ["coffee", "css", "html"];
      this.$codes = $(this.codes = {});
      this.root_pane = new PanesPane({
        orientation: "y"
      });
      this.root_pane.add(top_pane = new PanesPane({
        orientation: "x"
      }));
      this.root_pane.add(bottom_pane = new PanesPane({
        orientation: "x"
      }));
      top_pane.add(new EditorPane({
        project: this,
        lang: this.languages[0]
      }));
      top_pane.add(new EditorPane({
        project: this,
        lang: this.languages[1]
      }));
      bottom_pane.add(new EditorPane({
        project: this,
        lang: this.languages[2]
      }));
      bottom_pane.add(this.output_pane = new OutputPane({
        project: this
      }));
      this.root_pane.$.appendTo("body");
      this.root_pane.layout();
      this.applyTheme("tomorrow_night_bright");
      this.show(what_to_show);
      $G.on("resize", this._onresize = () => {
        return this.root_pane.layout();
      });
      $G.on("resized", this._onresized = () => {
        return this.updateIcon();
      });
      this.canvas = E("canvas");
      this.canvas.width = this.canvas.height = 16;
      // $("body").prepend @canvas
      // @canvas.style.border = "1px solid gray"
      // @canvas.style.margin = "19px"
      this.ctx = this.canvas.getContext("2d");
      this.link = E("link");
      this.link.rel = "icon";
      this.updateIcon();
    }

    applyTheme(theme_name) {
      var edpane, i, len, ref, results, theme;
      theme = themesByName[theme_name];
      if (theme.isDark) {
        $("body").addClass("dark");
      } else {
        $("body").removeClass("dark");
      }
      ref = EditorPane.instances;
      results = [];
      for (i = 0, len = ref.length; i < len; i++) {
        edpane = ref[i];
        results.push(edpane.editor.setTheme(theme.theme));
      }
      return results;
    }

    exit() {
      $G.off("resize", this._onresize);
      $G.off("resize", this._onresized);
      this.root_pane.destroy();
      return this.root_pane.$.remove();
    }

    show(what_to_show) {
      switch (what_to_show) {
        case "output":
          return $("body").addClass("show-output-only");
        default:
          return $("body").removeClass("show-output-only");
      }
    }

    updateIcon() {
      var h, i, leaf_el, leaf_rect, len, ref, root_rect, w, x, y;
      this.ctx.clearRect(0, 0, this.canvas.width, this.canvas.height);
      root_rect = this.root_pane.$[0].getBoundingClientRect();
      ref = $(".leaf-pane");
      for (i = 0, len = ref.length; i < len; i++) {
        leaf_el = ref[i];
        leaf_rect = leaf_el.getBoundingClientRect();
        x = this.canvas.width * (leaf_rect.left - root_rect.left) / root_rect.width;
        y = this.canvas.height * (leaf_rect.top - root_rect.top) / root_rect.height;
        w = this.canvas.width * leaf_rect.width / root_rect.width;
        h = this.canvas.height * leaf_rect.height / root_rect.height;
        this.ctx.fillStyle = (function() {
          switch ($(leaf_el).find(".label").text()) {
            case "CoffeeScript":
              return "#F0DB4F";
            case "JavaScript":
              return "#F0DB4F";
            case "CSS":
              return "#33A9DC";
            case "HTML":
              return "#F1662A";
            case "Output":
              return "#bd79d1";
            default:
              return "#000";
          }
        })();
        this.ctx.fillRect(~~x, ~~y, ~~w, ~~h);
        this.ctx.clearRect(~~x - 1, ~~y - 1, 1, ~~h + 1);
        this.ctx.clearRect(~~x - 1, ~~y - 1, ~~w + 1, 1);
      }
      this.ctx.save();
      this.ctx.fillStyle = "lime";
      this.ctx.globalCompositeOperation = "destination-in";
      this.ctx.arc(this.canvas.width / 2 - 0.5, this.canvas.height / 2 - 0.5, this.canvas.height / 2 - 0.5, 0, Math.PI * 2);
      this.ctx.fill();
      this.ctx.restore();
      this.link.href = this.canvas.toDataURL("image/png");
      return document.head.appendChild(this.link);
    }

  };

  fb_root = new Firebase("https://multifiddle.firebaseio.com/");

  hash = G.location.hash.replace('#', '');

  [project_id, what_to_show] = hash.split("/");

  if (hash) {
    fb_project = fb_root.child(project_id);
  } else {
    fb_project = fb_root.push();
    G.location = G.location + '#' + fb_project.key();
  }

  $(function() {
    var project;
    project = new Project(fb_project, what_to_show);
    $G.on("hashchange", function() {
      var new_hash, new_project_id, new_to_show;
      new_hash = G.location.hash.replace('#', '');
      [new_project_id, new_to_show] = new_hash.split("/");
      if (typeof console !== "undefined" && console !== null) {
        if (typeof console.debug === "function") {
          console.debug(`location hash changed from ${hash} to ${new_hash}`);
        }
      }
      if (new_project_id !== project_id) {
        project_id = new_project_id;
        if (typeof console !== "undefined" && console !== null) {
          if (typeof console.debug === "function") {
            console.debug(`switch project to ${new_project_id}`);
          }
        }
        project.exit();
        fb_project = fb_root.child(project_id);
        project = new Project(fb_project, new_to_show);
      }
      if (new_to_show !== what_to_show) {
        what_to_show = new_to_show;
        if (typeof console !== "undefined" && console !== null) {
          if (typeof console.debug === "function") {
            console.debug(`show ${new_to_show || "all panes"}`);
          }
        }
        return project.show(new_to_show);
      }
    });
    return $G.on("keydown", function(e) {
      var canvas, cell_size, col, ctrl_m, ctrl_s, ctx, escape, h, i, j, n_cells, output_only_url, qrcode, ref, ref1, row, size, w;
      ctrl_m = e.ctrlKey && e.keyCode === 77;
      ctrl_s = e.ctrlKey && e.keyCode === 83;
      escape = e.keyCode === 27;
      if (ctrl_s) {
        e.preventDefault();
      }
      if (escape || ctrl_m) {
        if ($(".qr-code-popup").length) {
          $(".qr-code-popup").remove();
          return e.preventDefault();
        }
      }
      if (ctrl_m) {
        e.preventDefault();
        output_only_url = location.origin.match(/127\.0\.0\.1|localhost|^file:/) ? `https://multifiddle.ml/#${project_id}/output` : `${location.origin}${location.pathname}#${project_id}/output`;
        size = 256;
        
        // create the qrcode itself
        qrcode = new QRCode(-1, QRErrorCorrectLevel.M);
        qrcode.addData(output_only_url);
        qrcode.make();
        
        // create canvas
        canvas = document.createElement("canvas");
        canvas.width = size;
        canvas.height = size;
        ctx = canvas.getContext("2d");
        n_cells = qrcode.getModuleCount();
        cell_size = size / n_cells;

// draw on the canvas
        for (row = i = 0, ref = n_cells; (0 <= ref ? i < ref : i > ref); row = 0 <= ref ? ++i : --i) {
          for (col = j = 0, ref1 = n_cells; (0 <= ref1 ? j < ref1 : j > ref1); col = 0 <= ref1 ? ++j : --j) {
            ctx.fillStyle = qrcode.isDark(row, col) ? "#000" : "#fff";
            w = Math.ceil((col + 1) * cell_size) - Math.floor(col * cell_size);
            h = Math.ceil((row + 1) * cell_size) - Math.floor(row * cell_size);
            ctx.fillRect(Math.round(col * cell_size), Math.round(row * cell_size), w, h);
          }
        }
        return $(canvas).addClass("qr-code-popup").appendTo("body").css({
          position: "absolute",
          margin: "auto",
          top: 0,
          left: 0,
          bottom: 0,
          right: 0,
          zIndex: 10,
          boxShadow: "#0083F5 0 0 180px",
          border: "5px solid rgba(0, 131, 245, 0.6)"
        });
      }
    });
  });

}).call(this);
